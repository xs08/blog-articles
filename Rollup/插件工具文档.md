# Rollup.js æ’ä»¶ç¼–å†™å®ä¾‹



## æ’ä»¶ç¼–å†™å·¥å…·ï¼š`@rollup/pluginutils`

ğŸ£ Rollupæ’ä»¶ä¸­é€šç”¨çš„**å·¥å…·å‡½æ•°**é›†åˆï¼Œæ­¤é›†åˆéœ€è¦ Node.js LTS(v8.0.0+) ä»¥åŠ Rollup v1.20.0 ä»¥ä¸Šæ”¯æŒã€‚ä½¿ç”¨æ—¶éœ€è¦å•ç‹¬å®‰è£…: `npm i @rollup/pluginutils -D`ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
```javascript
import utils from '@rollup/pluginutils'
```

### æ’ä»¶å·¥å…·API
å·¥å…·é›†åˆä¸­å¯ç”¨çš„åŠŸèƒ½å‡½æ•°å¦‚ä¸‹ï¼š(æ³¨æ„ï¼šå‚æ•°åé¢åŠ **?**è¡¨ç¤ºä¸ºå¯é€‰å‚æ•°)

#### 1. addExtension: å¦‚æœä¸€ä¸ªæ¨¡å—ID**ä¸å­˜åœ¨åç¼€**ï¼Œåˆ™ä¼šåŠ ä¸Šç»™å®šçš„åç¼€(é»˜è®¤ä¸º`.js`)
* å‚æ•°ï¼š`ï¼ˆfilename: String, ext?: string)`
* è¿”å›å€¼ï¼š`String`
```javascript
import { addExtensions } from '@rollup/pluginutils'

export default function myPlugin(options = {}) {
	return {
		resolveId(code, id) {
			id = addExtension(id); // `foo` -> `foo.js`, `foo.js` -> `foo.js`
			id = addExtension(id, '.myext'); // `foo` -> `foo.myext`, `foo.js` -> `foo.js`
		}
	}
}
```

#### 2.  attachScopes: å°†èŒƒå›´å¯¹è±¡é™„åŠ åˆ°ASTçš„ç›¸å…³èŠ‚ç‚¹ã€‚æ¯ä¸ªScopeå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªscope.containsï¼ˆnameï¼‰æ–¹æ³•ï¼Œå¦‚æœåœ¨å½“å‰èŒƒå›´æˆ–çˆ¶èŒƒå›´ä¸­å®šä¹‰äº†ç»™å®šåç§°ï¼Œåˆ™è¯¥æ–¹æ³•è¿”å›trueã€‚
* å‚æ•°: `(ast: Node, propertyName?: String)`
* è¿”å›å€¼: `Object`
å¯ä»¥å‚è€ƒï¼š [rollup-plugin-inject](https://github.com/rollup/rollup-plugin-inject) ã€[rollup-plugin-commonjs](https://github.com/rollup/rollup-plugin-commonjs)
```javascript
import { attachScopes } from '@rollup/pluginutils'
import { walk } from 'estree-walker'

export default function myPlugin(options = {}) {
	return {
		transform(code) {
			const ast = this.parse(code)
			
			let scope = attachScopes(ast, 'scope')
			walk(ast, {
				enter(node) {
					if (node.scope) scope = node.scope
					
					if (!scope.contains('foo')) {
						// `foo`æœªå®šä¹‰çš„ï¼Œå¦‚æœé‡è§æ—¶ï¼Œå‡è®¾ä»–æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡
					}
				},
				leave(node) {
					if (node.scope) scope = scope.parent
				}
			})
		}
	}
}
```


#### 3. createFilter: æ„å»ºä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºç¡®å®šæ˜¯å¦å¯¹æŸäº›æ¨¡å—è¿›è¡Œæ“ä½œ
* å‚æ•°: `(include?: <picomatch>, exclude?:<picomatch>, options?: Object)`
* è¿”å›å€¼: `String`



#### 4. dataToEsm: å°†å¯¹è±¡è½¬ä¸º `tree-shakable` çš„ ES æ¨¡å—å¯¼å…¥
* å‚æ•°: `(data: Object, options?)`: **Object**: è¦è½¬ä¸ºESæ¨¡å—çš„å¯¹è±¡
* è¿”å›å€¼: `String`
```javascript
import { dataToEsm } from '@rollup/pluginutils'

const esModuleSource = dataToEsm(
	{
		custom: 'data',
		to: ['treeshake']
	},
	{
		compact: false,
		indent: '\t',
		preferConst: false,
		objectShorthand: false,
		namedExports: true,
	}
)
/*
è¾“å‡ºçš„å­—ç¬¦ä¸²æ ¼å¼ ES æ¨¡å—æºç ä¸º:
  export const custom = 'data';
  export const to = ['treeshake'];
  export default { custom, to };
*/
```


#### 5. exactAssignedNames: æ ¹æ®æŒ‡å®šçš„æ¨¡å¼æå–æ‰€æœ‰åˆ†é…ç›®æ ‡çš„åç§°ã€‚
* å‚æ•°: `(param: Node)`: **Node**: ASTèŠ‚ç‚¹ acorn
* è¿”å›å€¼: `Array[...String]`
```javascript
import { exactAssignedNames } from '@rollup/pluginutils'
import { walk } from 'estree-walker'

export default function myPlugin(options = {}) {
	return {
		transform(code) {
			const ast = this.parse(code);
			
			walk(ast, {
				enter(node) {
					if (node.type === 'VariableDeclarator') {
						// ä½¿ç”¨å£°æ˜çš„åç§°
						const declareNames = extractAssignedNames(ndoe.id)
					}
				}
			})
		}
	}
}

```


#### 6. makeLegalIdentifier: ä»å­—ç¬¦ä¸²æ„å»ºå®‰å…¨çš„æ ‡è¯†ç¬¦å­—ç¬¦ä¸²ã€‚
* å‚æ•°: `(str: String)`
* è¿”å›å€¼: `String`
```javascript
import { makeLegalIdentifier } from '@rollup/pluginutils'

makeLegalIdentifier('foo-bar'); // 'foo_bar'
makeLegalIdentifier('typeof'); // '_typeof'
```



#### 7. normalizePath: å°†è·¯åŠ²è½¬ä¸ºæ­£æ–œæ ã€‚ä¾¿äºwindows/*unix è·¯åŠ²ç»Ÿä¸€å¤„ç†
* å‚æ•°: `(filename: string)`
* è¿”å›å€¼: `String`
```javascript
import {} from '@rollup/pluginutils'

normalizePath('foo\\bar'); // 'foo/bar'
normalizePath('foo/bar'); // 'foo/bar'
```



